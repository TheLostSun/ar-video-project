<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AR Video Placement</title>

<style>
body {
  margin:0;
  overflow:hidden;
  font-family:sans-serif;
  background:#000;
}

/* Centered blue start button */
#startARBtn {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  padding:16px 28px;
  font-size:18px;
  background:#007bff;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  z-index:10;
}

/* Instruction text */
#instruction {
  position:absolute;
  top:20px;
  width:100%;
  text-align:center;
  color:white;
  font-size:18px;
  display:none;
  z-index:10;
}

/* Bottom buttons */
#resetBtn, #restartBtn {
  position:absolute;
  bottom:20px;
  padding:12px 20px;
  font-size:16px;
  display:none;
  z-index:10;
}

#resetBtn { left:20px; }
#restartBtn { right:20px; }
</style>
</head>

<body>

<button id="startARBtn">Start AR</button>

<div id="instruction">
Hold your phone steady and look towards a flat surface
</div>

<button id="resetBtn">Reset Placement</button>
<button id="restartBtn">Restart Video</button>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js';

let camera, scene, renderer;
let controller;
let reticle;
let video, videoTexture, videoMesh;
let hitTestSource = null;
let hitTestSourceRequested = false;
let placed = false;

const startBtn = document.getElementById("startARBtn");
const instruction = document.getElementById("instruction");
const resetBtn = document.getElementById("resetBtn");
const restartBtn = document.getElementById("restartBtn");

init();

function init() {

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;

  document.body.appendChild(renderer.domElement);

  controller = renderer.xr.getController(0);
  controller.addEventListener('select', onSelect);
  scene.add(controller);

  /* Reticle */
  const geometry = new THREE.RingGeometry(0.08, 0.1, 32);
  geometry.rotateX(-Math.PI / 2);
  const material = new THREE.MeshBasicMaterial({ color:0xffffff });
  reticle = new THREE.Mesh(geometry, material);
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  resetBtn.onclick = resetPlacement;
  restartBtn.onclick = restartVideo;

  renderer.setAnimationLoop(render);

  startBtn.onclick = startAR;
}

async function startAR() {

  const session = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['hit-test'],
    domOverlay: { root: document.body }   // âœ… keeps UI visible
  });

  renderer.xr.setReferenceSpaceType('local');
  await renderer.xr.setSession(session);

  startBtn.style.display = "none";
  instruction.style.display = "block";
}

/* Placement */
function onSelect() {

  if (!reticle.visible || placed) return;

  const geometry = new THREE.PlaneGeometry(1.2, 0.7);

  video = document.createElement('video');
  video.src = "video.mp4";
  video.loop = true;
  video.muted = true;
  video.playsInline = true;
  video.play();

  videoTexture = new THREE.VideoTexture(video);
  videoTexture.colorSpace = THREE.SRGBColorSpace;

  const material = new THREE.MeshBasicMaterial({
    map: videoTexture,
    side: THREE.DoubleSide
  });

  videoMesh = new THREE.Mesh(geometry, material);

  /* Position from reticle */
  videoMesh.position.setFromMatrixPosition(reticle.matrix);

  /* Perpendicular to surface (NOT camera facing) */
  const rotation = new THREE.Quaternion();
  reticle.matrix.decompose(
    new THREE.Vector3(),
    rotation,
    new THREE.Vector3()
  );
  videoMesh.quaternion.copy(rotation);

  scene.add(videoMesh);

  placed = true;
  reticle.visible = false;
  instruction.style.display = "none";

  resetBtn.style.display = "block";
  restartBtn.style.display = "block";
}

function resetPlacement() {

  if (videoMesh) {
    scene.remove(videoMesh);
    videoMesh = null;
  }

  if (video) {
    video.pause();
    video.currentTime = 0;
  }

  placed = false;
  reticle.visible = true;
  instruction.style.display = "block";

  resetBtn.style.display = "none";
  restartBtn.style.display = "none";
}

function restartVideo() {
  if (video) {
    video.currentTime = 0;
    video.play();
  }
}

function render(timestamp, frame) {

  if (frame) {

    const referenceSpace = renderer.xr.getReferenceSpace();
    const session = renderer.xr.getSession();

    if (!hitTestSourceRequested) {

      session.requestReferenceSpace('viewer').then((space)=>{
        session.requestHitTestSource({ space:space }).then((source)=>{
          hitTestSource = source;
        });
      });

      session.addEventListener('end', ()=>{
        hitTestSourceRequested = false;
        hitTestSource = null;
      });

      hitTestSourceRequested = true;
    }

    if (hitTestSource && !placed) {

      const hitTestResults = frame.getHitTestResults(hitTestSource);

      if (hitTestResults.length) {

        const hit = hitTestResults[0];
        const pose = hit.getPose(referenceSpace);

        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);

      } else {
        reticle.visible = false;
      }
    }
  }

  renderer.render(scene, camera);
}
</script>

</body>
</html>
